name: Validate OpenAPI Spec

on:
  pull_request:
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '**/*.json'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenAPI validator
        run: npm install -g @apidevtools/swagger-cli

      - name: Find OpenAPI spec files
        id: find_specs
        run: |
          # Find all potential OpenAPI spec files
          SPEC_FILES=$(find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \) | head -20)
          echo "Found files:"
          echo "$SPEC_FILES"
          echo "spec_files<<EOF" >> $GITHUB_OUTPUT
          echo "$SPEC_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate OpenAPI specs
        run: |
          VALIDATION_FAILED=0

          # Check each file to see if it's an OpenAPI spec
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            # Skip hidden files and node_modules
            if [[ "$file" == *"/."* ]] || [[ "$file" == *"node_modules"* ]]; then
              continue
            fi

            # Check if file contains OpenAPI indicator
            if grep -q -E "(openapi|swagger).*['\"]?[0-9]+\.[0-9]+" "$file" 2>/dev/null; then
              echo "Validating OpenAPI spec: $file"
              if swagger-cli validate "$file" 2>&1; then
                echo "✅ $file is valid"
              else
                echo "❌ $file validation failed"
                VALIDATION_FAILED=1
              fi
            fi
          done <<< "${{ steps.find_specs.outputs.spec_files }}"

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "::error::One or more OpenAPI specs failed validation"
            exit 1
          fi

          echo "✅ All OpenAPI specs are valid"

      - name: Check for breaking changes
        run: |
          echo "OpenAPI validation complete"
          echo "Future: Add breaking change detection with oasdiff or similar"
